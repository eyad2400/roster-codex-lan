(function(){
  if (window.html2canvas) return;
  window.__html2canvasFallback = true;
  window.html2canvas = function(element, opts){
    opts = opts || {};
    return new Promise(function(resolve, reject){
      try {
        var scale = opts.scale || 1;
        var backgroundColor = opts.backgroundColor || '#fff';
        var rect = element.getBoundingClientRect();
        var width = Math.max(element.scrollWidth || rect.width, rect.width);
        var height = Math.max(element.scrollHeight || rect.height, rect.height);
        var styles = Array.from(document.querySelectorAll('style')).map(function(s){ return s.outerHTML; }).join('\n');
        var serializer = new XMLSerializer();
        var clonedHtml = serializer.serializeToString(element.cloneNode(true));
        var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="' + width + '" height="' + height + '"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">' + styles + clonedHtml + '</div></foreignObject></svg>';
        var img = new Image();
        img.onload = function(){
          var canvas = document.createElement('canvas');
          canvas.width = width * scale;
          canvas.height = height * scale;
          var ctx = canvas.getContext('2d');
          if (backgroundColor){
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }
          ctx.scale(scale, scale);
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas);
        };
        img.onerror = reject;
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      } catch (err) {
        reject(err);
      }
    });
  };
})();
